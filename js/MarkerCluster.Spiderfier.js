L.MarkerCluster.include({_2PI:Math.PI*2,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_circleSpiralSwitchover:9,spiderfy:function(){if(this._group._spiderfied===this||this._group._inZoomAnimation)return;var childMarkers=this.getAllChildMarkers(),group=this._group,map=group._map,center=map.latLngToLayerPoint(this._latlng),positions;this._group._unspiderfy();this._group._spiderfied=this;if(childMarkers.length>=this._circleSpiralSwitchover){positions=this._generatePointsSpiral(childMarkers.length,center)}else{center.y+=10;positions=this._generatePointsCircle(childMarkers.length,center)};this._animationSpiderfy(childMarkers,positions)},unspiderfy:function(zoomDetails){if(this._group._inZoomAnimation)return;this._animationUnspiderfy(zoomDetails);this._group._spiderfied=null},_generatePointsCircle:function(count,centerPt){var circumference=this._group.options.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+count),legLength=circumference/this._2PI,angleStep=this._2PI/count,res=[],i,angle;res.length=count;for(i=count-1;i>=0;i--){angle=this._circleStartAngle+i*angleStep;res[i]=new L.Point(centerPt.x+legLength*Math.cos(angle),centerPt.y+legLength*Math.sin(angle))._round()};return res},_generatePointsSpiral:function(count,centerPt){var spiderfyDistanceMultiplier=this._group.options.spiderfyDistanceMultiplier,legLength=spiderfyDistanceMultiplier*this._spiralLengthStart,separation=spiderfyDistanceMultiplier*this._spiralFootSeparation,lengthFactor=spiderfyDistanceMultiplier*this._spiralLengthFactor*this._2PI,angle=0,res=[],i;res.length=count;for(i=count-1;i>=0;i--){angle+=separation/legLength+i*0.0005;res[i]=new L.Point(centerPt.x+legLength*Math.cos(angle),centerPt.y+legLength*Math.sin(angle))._round();legLength+=lengthFactor/angle};return res},_noanimationUnspiderfy:function(){var group=this._group,map=group._map,fg=group._featureGroup,childMarkers=this.getAllChildMarkers(),m,i;group._ignoreMove=true;this.setOpacity(1);for(i=childMarkers.length-1;i>=0;i--){m=childMarkers[i];fg.removeLayer(m);if(m._preSpiderfyLatlng){m.setLatLng(m._preSpiderfyLatlng);delete m._preSpiderfyLatlng};if(m.setZIndexOffset)m.setZIndexOffset(0);if(m._spiderLeg){map.removeLayer(m._spiderLeg);delete m._spiderLeg}};group.fire('unspiderfied',{cluster:this,markers:childMarkers});group._ignoreMove=false;group._spiderfied=null}});L.MarkerClusterNonAnimated=L.MarkerCluster.extend({_animationSpiderfy:function(childMarkers,positions){var group=this._group,map=group._map,fg=group._featureGroup,legOptions=this._group.options.spiderLegPolylineOptions,i,m,leg,newPos;group._ignoreMove=true;for(i=0;i<childMarkers.length;i++){newPos=map.layerPointToLatLng(positions[i]);m=childMarkers[i];leg=new L.Polyline([this._latlng,newPos],legOptions);map.addLayer(leg);m._spiderLeg=leg;m._preSpiderfyLatlng=m._latlng;m.setLatLng(newPos);if(m.setZIndexOffset)m.setZIndexOffset(1000000);fg.addLayer(m)};this.setOpacity(0.3);group._ignoreMove=false;group.fire('spiderfied',{cluster:this,markers:childMarkers})},_animationUnspiderfy:function(){this._noanimationUnspiderfy()}});L.MarkerCluster.include({_animationSpiderfy:function(childMarkers,positions){var me=this,group=this._group,map=group._map,fg=group._featureGroup,thisLayerLatLng=this._latlng,thisLayerPos=map.latLngToLayerPoint(thisLayerLatLng),svg=L.Path.SVG,legOptions=L.extend({},this._group.options.spiderLegPolylineOptions),finalLegOpacity=legOptions.opacity,i,m,leg,legPath,legLength,newPos;if(finalLegOpacity===undefined)finalLegOpacity=L.MarkerClusterGroup.prototype.options.spiderLegPolylineOptions.opacity;if(svg){legOptions.opacity=0;legOptions.className=(legOptions.className||'')+' leaflet-cluster-spider-leg'}else legOptions.opacity=finalLegOpacity;group._ignoreMove=true;for(i=0;i<childMarkers.length;i++){m=childMarkers[i];newPos=map.layerPointToLatLng(positions[i]);leg=new L.Polyline([thisLayerLatLng,newPos],legOptions);map.addLayer(leg);m._spiderLeg=leg;if(svg){legPath=leg._path;legLength=legPath.getTotalLength()+0.1;legPath.style.strokeDasharray=legLength;legPath.style.strokeDashoffset=legLength};if(m.setZIndexOffset)m.setZIndexOffset(1000000);if(m.clusterHide)m.clusterHide();fg.addLayer(m);if(m._setPos)m._setPos(thisLayerPos)};group._forceLayout();group._animationStart();for(i=childMarkers.length-1;i>=0;i--){newPos=map.layerPointToLatLng(positions[i]);m=childMarkers[i];m._preSpiderfyLatlng=m._latlng;m.setLatLng(newPos);if(m.clusterShow)m.clusterShow();if(svg){leg=m._spiderLeg;legPath=leg._path;legPath.style.strokeDashoffset=0;leg.setStyle({opacity:finalLegOpacity})}};this.setOpacity(0.3);group._ignoreMove=false;setTimeout(function(){group._animationEnd();group.fire('spiderfied',{cluster:me,markers:childMarkers})},200)},_animationUnspiderfy:function(zoomDetails){var me=this,group=this._group,map=group._map,fg=group._featureGroup,thisLayerPos=zoomDetails?map._latLngToNewLayerPoint(this._latlng,zoomDetails.zoom,zoomDetails.center):map.latLngToLayerPoint(this._latlng),childMarkers=this.getAllChildMarkers(),svg=L.Path.SVG,m,i,leg,legPath,legLength,nonAnimatable;group._ignoreMove=true;group._animationStart();this.setOpacity(1);for(i=childMarkers.length-1;i>=0;i--){m=childMarkers[i];if(!m._preSpiderfyLatlng)continue;m.setLatLng(m._preSpiderfyLatlng);delete m._preSpiderfyLatlng;nonAnimatable=true;if(m._setPos){m._setPos(thisLayerPos);nonAnimatable=false};if(m.clusterHide){m.clusterHide();nonAnimatable=false};if(nonAnimatable)fg.removeLayer(m);if(svg){leg=m._spiderLeg;legPath=leg._path;legLength=legPath.getTotalLength()+0.1;legPath.style.strokeDashoffset=legLength;leg.setStyle({opacity:0})}};group._ignoreMove=false;setTimeout(function(){var stillThereChildCount=0;for(i=childMarkers.length-1;i>=0;i--){m=childMarkers[i];if(m._spiderLeg)stillThereChildCount++};for(i=childMarkers.length-1;i>=0;i--){m=childMarkers[i];if(!m._spiderLeg)continue;if(m.clusterShow)m.clusterShow();if(m.setZIndexOffset)m.setZIndexOffset(0);if(stillThereChildCount>1)fg.removeLayer(m);map.removeLayer(m._spiderLeg);delete m._spiderLeg};group._animationEnd();group.fire('unspiderfied',{cluster:me,markers:childMarkers})},200)}});L.MarkerClusterGroup.include({_spiderfied:null,unspiderfy:function(){this._unspiderfy.apply(this,arguments)},_spiderfierOnAdd:function(){this._map.on('click',this._unspiderfyWrapper,this);if(this._map.options.zoomAnimation)this._map.on('zoomstart',this._unspiderfyZoomStart,this);this._map.on('zoomend',this._noanimationUnspiderfy,this);if(!L.Browser.touch)this._map.getRenderer(this)},_spiderfierOnRemove:function(){this._map.off('click',this._unspiderfyWrapper,this);this._map.off('zoomstart',this._unspiderfyZoomStart,this);this._map.off('zoomanim',this._unspiderfyZoomAnim,this);this._map.off('zoomend',this._noanimationUnspiderfy,this);this._noanimationUnspiderfy()},_unspiderfyZoomStart:function(){if(!this._map)return;this._map.on('zoomanim',this._unspiderfyZoomAnim,this)},_unspiderfyZoomAnim:function(zoomDetails){if(L.DomUtil.hasClass(this._map._mapPane,'leaflet-touching'))return;this._map.off('zoomanim',this._unspiderfyZoomAnim,this);this._unspiderfy(zoomDetails)},_unspiderfyWrapper:function(){this._unspiderfy()},_unspiderfy:function(zoomDetails){if(this._spiderfied)this._spiderfied.unspiderfy(zoomDetails)},_noanimationUnspiderfy:function(){if(this._spiderfied)this._spiderfied._noanimationUnspiderfy()},_unspiderfyLayer:function(layer){if(layer._spiderLeg){this._featureGroup.removeLayer(layer);if(layer.clusterShow)layer.clusterShow();if(layer.setZIndexOffset)layer.setZIndexOffset(0);this._map.removeLayer(layer._spiderLeg);delete layer._spiderLeg}}})